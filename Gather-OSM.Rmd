---
title: "Explore Points of Interest - OSM"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(osmdata)
library(sf)
library(tidyverse)
library(tmap)
```

## Load Data

Shape file from 2016 Market Value Analysis

```{r}
# read shape file of KC from MVA study
kcmo_mva_sf <- st_read("Data/2016 Market Value Analysis (MVA)/geo_export_8a3f2884-9896-4c60-ba20-c985177b689a.shp")
# its CRS = 4326 - unprojected (geo with lon/lat)
```

```{r}
# Create boundary for KCMO as a whole and transform to a projected CRS
# At this point, I don't care about Census Block Groups
# 
# EPSG:2817 = https://spatialreference.org/ref/epsg/nad83harn-missouri-west/

kc_boundary_sf   <- st_union(kcmo_mva_sf)
kc_boundary_prjd <- st_transform(kc_boundary_sf, crs=2817) 
```

## Get Data from OSM on Fuel Stations

Provide the bounding box that matches the area of the MVA study rather accept the bounding box generated by OSM for Kansas City.

```{r}
# get bounding box for MVA study, turn it into a matrix in format OSM accepts
kc_bbox_matrix <- matrix(st_bbox(kcmo_mva_sf), ncol=2, byrow=FALSE)
row.names(kc_bbox_matrix) <- c("x","y")
colnames(kc_bbox_matrix)  <- c("min","max")

# get bounding box OSM would generate for KC, Mo as 'place_name')
osm_metro_bbox_matrix <- getbb("Kansas City, Missouri")

# MVA's KC ... starts a touch further W and extends a bit more E, starts about the same on S but extends more N
kc_bbox_matrix
osm_metro_bbox_matrix
```

Get fuel stations in Kansas City from OSM

```{r}
# fuel_df <- opq(getbb("Kansas City, Missouri")) %>%       # get bounding box for city

fuel_df <- kc_bbox_matrix %>% opq() %>%                  # use kc bbox from MVA study area
  add_osm_feature(key="amenity", value="fuel") %>%       # search for fuel amenities
  osmdata_sf()      
```

Review data returned by OSM

```{r}
# Data Retrieved on ...
fuel_df$meta$timestamp

# Nbr of Points
nrow(fuel_df$osm_points)

# Nbr of Polygons
nrow(fuel_df$osm_polygons)
```

Returns entries as both points and polygons.

### Explore Points returned by OSM

```{r}
# select point data from download OSM data (only keep name & brand attributes provide by OSM)

fuel_pts <- fuel_df$osm_points %>%
  dplyr::select(name, brand, geometry)

head(fuel_pts)

# transform to a projected CRS
fuel_pts_prjd <- st_transform(fuel_pts, crs=2817) 
```

#### Plot Points

```{r}
tmap_mode("view") 

tm_shape(kc_boundary_sf) +
  tm_borders(lwd=3) +
  
tm_shape(fuel_pts) +
  tm_dots(col="red")

tmap_mode("plot")
```

### Explore Polygons returned by OSM
```{r}
# select polygon data from download OSM data (only keep name & brand attributes provide by OSM)
fuel_polys <- fuel_df$osm_polygons %>%
  dplyr::select(name, brand, geometry)

head(fuel_polys)

# transform to a projected CRS
fuel_polys_prjd <- st_transform(fuel_polys, crs=2817)
```

#### Plot Points & Polygons

If you zoom in enough, many of the points are corners of the polygons - not really a gas station itself.

```{r}
tmap_mode("view") 

tm_shape(kc_boundary_sf) +
  tm_borders(lwd=3) +

tm_shape(fuel_polys) +
  tm_polygons(col="green") +

# tm_shape(st_centroid(fuel_polys)) +
#   tm_dots(col="green") +
  
tm_shape(fuel_pts) +
  tm_dots(col="red")

tmap_mode("plot")
```

```{r}
# 1341 - if points are corners of polys they would touch
sum(st_touches(fuel_pts_prjd, fuel_polys_prjd, sparse=FALSE))

# 4
sum(st_within(fuel_pts_prjd, fuel_polys_prjd, sparse=FALSE))

# 1345 (1341 touches + 4 points contained ... polygons)
sum(st_intersects(fuel_pts_prjd, fuel_polys_prjd, sparse=FALSE))

# Find the points that do NOT intersect the polygons - points that are truly a fuel station not represented as a polygon

# retain the original points in another variable and so we can reuse the current variable for the valid points
# 1421 points
fuel_pts_prjd_original <- fuel_pts_prjd

# 78 of 1421 are points not associated with a polygon
fuel_pts_prjd <- fuel_pts_prjd_original[lengths(st_intersects(fuel_pts_prjd_original, fuel_polys_prjd))==0, ]

# head(fuel_pts_prjd)
```

#### Plot Points & Polygons, Again

Plot the centroid of the polygon as a green point and the red points are the points returned by OSM data did not overlap a polygon.

Note: The polygons are really small compared to the default size of a dot, hence plotting the centroid is more helpful.

```{r}
tmap_mode("view") 

tm_shape(kc_boundary_prjd) +
  tm_borders(lwd=3) +

# tm_shape(fuel_polys_prjd) +
#   tm_polygons(col="green") +

tm_shape(st_centroid(fuel_polys_prjd)) +
   tm_dots(col="green") +
  
tm_shape(fuel_pts_prjd) +
  tm_dots(col="red")

tmap_mode("plot")
```

### Represent all the fuel stations as points (rather than points and polygons)

* Convert fuel polygons to a point (use centroid of poly)
* Consolidate the centroid point of polys to the fuel stations returned as points
* Add a 1/2 mile buffer around KC
* Only keep the fuel stations with KCMO (vs. the whole metro area)

```{r}
kc_metro_fuel_pts_prjd <- rbind(fuel_pts_prjd, st_centroid(fuel_polys_prjd))

# keep points with KCMO (vs. whole metro area)

# add 0.5 mile buffer around KCMO's border (0.5 mile ~ 805 meters)
kc_boundary_buffer_prjd <- st_buffer(kc_boundary_prjd, dist=805)

# Select/keep the points with the KCMO (+buffer) boundary
logical_win_boundary <- lengths(st_within(kc_metro_fuel_pts_prjd, kc_boundary_buffer_prjd)) > 0

kcmo_fuel_pts_prjd <- kc_metro_fuel_pts_prjd[logical_win_boundary, ]
```

#### Visualize ...

KC boundary and 1/2 mile buffer zone, included fuel stations in red, excluded in pink.

```{r}
tmap_mode("view") 

tm_shape(kc_boundary_buffer_prjd) +
  tm_borders(lwd=1, lty=3, col="blue") +
  
tm_shape(kc_boundary_prjd) +
  tm_borders(lwd=3) +

tm_shape(kc_metro_fuel_pts_prjd) +
  tm_dots(col="pink") +

tm_shape(kcmo_fuel_pts_prjd) +
  tm_dots(col="red")

tmap_mode("plot")
```

### Clean up names associated with Fuel Stations
```{r}
kcmo_fuel_pts_prjd %>%
  group_by(name) %>%
  count() %>%
  arrange(desc(n))
```

```{r}
# clean up names, at bit
kcmo_fuel_pts_prjd <- kcmo_fuel_pts_prjd %>% 
  mutate(brandname = ifelse(!is.na(name), name, ifelse(!is.na(brand), brand, "Unknown"))) %>% 
  mutate(brandname = ifelse(brandname=="Conoco Oil", "Conoco", brandname)) %>% 
  mutate(brandname = ifelse(brandname=="Fleming / Conoco", "Conoco", brandname)) %>% 
  mutate(brandname = ifelse(brandname=="Costco Gas Station", "Costco Gasoline", brandname)) %>% 
  mutate(brandname = ifelse(brandname=="Pilot Gas", "Pilot", brandname)) %>% 
  mutate(brandname = ifelse(brandname=="Pilot Truck Stop", "Pilot", brandname)) %>%  
  mutate(brandname = ifelse(brandname=="QuikTrip Gas & Convenience Store", "QuikTrip", brandname)) %>% 
  mutate(brandname = ifelse(brandname=="HyVee", "Hy-Vee Gas", brandname)) %>% 
  mutate(brandname = ifelse(brandname=="Sam's Club Gas Station", "Sam's Club Gas", brandname)) 
```

### Save Fuel Stations to a SHP file
```{r}
# write with st_write
kcmo_fuel_pts_prjd %>% 
  select(brandname) %>% 
  st_write("Data/kcmo_fuelstations.shp", 
         layer ="kcmo_fuelstations.shp", driver = "ESRI Shapefile",
         delete_layer = TRUE)

# example of read file back in
# fuel_stations <- st_read("Data/kcmo_fuelstations.shp")
```



